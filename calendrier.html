<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Annuel des Messes</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .mois-container { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .mois-header { 
            background: #f8f9fa; padding: 15px; cursor: pointer; 
            font-weight: bold; font-size: 1.2em; display: flex; 
            justify-content: space-between; align-items: center;
            text-transform: capitalize;
        }
        .mois-header:hover { background: #edf2f7; }
        .messes-content { display: none; padding: 10px; background: white; }
        .messes-content.active { display: block; }

        .messe-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; margin-bottom: 8px; border-radius: 6px;
            border-left: 5px solid; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .libre { border-left-color: #28a745; }
        .prise { border-left-color: #dc3545; background: #fff5f5; }
        
        .date-principale { font-weight: bold; color: #2c3e50; text-transform: capitalize; }
        .horaire { color: #5a67d8; font-size: 0.9em; font-weight: bold; }
        .btn-proposer { background: #5a67d8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="menu-container"></div>

    <main>
        <h1>Agenda des Messes 2026</h1>
        <div id="chargement" style="text-align: center; padding: 40px;"><strong>Chargement de l'annÃ©e...</strong></div>
        <div id="accordeon-messes"></div>
    </main>

    <script src="config.js"></script>
    <script src="menu.js"></script>
    <script>
        const GOOGLE_API_KEY = 'AIzaSyAI5N6lamviexKaPR-WoOP4006m5IClDoQ';
        const CALENDAR_ID = 'saintlouisenville67@gmail.com';

        async function chargerAgendaMensuel() {
            try {
                const { data: intentions } = await maConnexion.from('intentions').select('date_messe, nom_intention').eq('statut', 'valide');
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1).toISOString();
                const url = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${GOOGLE_API_KEY}&timeMin=${startOfYear}&singleEvents=true&orderBy=startTime&maxResults=250`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const container = document.getElementById('accordeon-messes');
                document.getElementById('chargement').style.display = 'none';

                const messesParMois = {};

                data.items.forEach(event => {
                    if (event.summary.toLowerCase().includes('messe')) {
                        const start = event.start.dateTime || event.start.date;
                        const dateObj = new Date(start);
                        const moisNom = dateObj.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                        
                        if (!messesParMois[moisNom]) messesParMois[moisNom] = [];
                        messesParMois[moisNom].push({ event, dateObj });
                    }
                });

                for (const [mois, messes] of Object.entries(messesParMois)) {
                    const moisDiv = document.createElement('div');
                    moisDiv.className = 'mois-container';
                    
                    moisDiv.innerHTML = `
                        <div class="mois-header" onclick="toggleMois(this)">
                            <span>${mois}</span>
                            <span>${messes.length} messes â–¾</span>
                        </div>
                        <div class="messes-content"></div>
                    `;

                    const contentDiv = moisDiv.querySelector('.messes-content');
                    messes.forEach(({event, dateObj}) => {
                        const dateISO = dateObj.toISOString().split('T')[0];
                        const dateFr = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric' });
                        const heureFr = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }).replace(':', 'h');
                        const intention = intentions ? intentions.find(i => i.date_messe === dateISO) : null;
                        const estLibre = !intention;

                        const item = document.createElement('div');
                        item.className = `messe-item ${estLibre ? 'libre' : 'prise'}`;
                        item.innerHTML = `
                            <div>
                                <div class="date-principale">${dateFr}</div>
                                <div class="horaire">ðŸ•’ ${heureFr} - ${event.summary}</div>
                            </div>
                            <div>
                                ${estLibre ? `<button class="btn-proposer" onclick="copierProposition('${dateFr} ${mois}', '${heureFr}')">ðŸ“§ Proposer</button>` 
                                           : `<span style="color:#c53030; font-weight:bold;">${intention.nom_intention}</span>`}
                            </div>
                        `;
                        contentDiv.appendChild(item);
                    });
                    container.appendChild(moisDiv);
                }
            } catch (e) { document.getElementById('chargement').innerText = "Erreur de chargement."; }
        }

        function toggleMois(header) {
            header.nextElementSibling.classList.toggle('active');
        }

        function copierProposition(date, heure) {
            navigator.clipboard.writeText(`Nous vous proposons de cÃ©lÃ©brer cette intention le ${date} Ã  ${heure}.`).then(() => alert("CopiÃ© !"));
        }

        window.onload = chargerAgendaMensuel;
    </script>
</body>
</html>
