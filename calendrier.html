<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Messes et Disponibilités</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="menu-container"></div>

    <main>
        <h1>Prochaines Messes</h1>
        <p>Consultez les dates disponibles pour proposer une nouvelle intention au paroissien.</p>

        <div id="liste-messes-container" class="card">
            <div id="chargement">Chargement des messes depuis l'agenda...</div>
            <ul id="messes-list" style="list-style: none; padding: 0;"></ul>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="menu.js"></script>
    <script>
        const GOOGLE_API_KEY = 'AIzaSyAI5N6lamviexKaPR-WoOP4006m5IClDoQ';
        const CALENDAR_ID = 'saintlouisenville67@gmail.com';

        async function fetchMessesEtIntentions() {
            try {
                // 1. Récupérer les intentions validées sur Supabase
                const { data: intentions } = await maConnexion
                    .from('intentions')
                    .select('date_messe, nom_intention')
                    .eq('statut', 'valide');

                // 2. Récupérer les événements Google Calendar (30 prochains jours)
                const now = new Date().toISOString();
                const url = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${GOOGLE_API_KEY}&timeMin=${now}&singleEvents=true&orderBy=startTime&maxResults=20`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const listElement = document.getElementById('messes-list');
                document.getElementById('chargement').style.display = 'none';
                listElement.innerHTML = "";

                if (data.items) {
                    data.items.forEach(event => {
                        // On ne garde que ce qui contient "Messe"
                        if (event.summary.toLowerCase().includes('messe')) {
                            const start = event.start.dateTime || event.start.date;
                            const dateObj = new Date(start);
                            const dateISO = dateObj.toISOString().split('T')[0];
                            const dateFr = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                            const heureFr = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                            // Vérification de la disponibilité
                            const intention = intentions ? intentions.find(i => i.date_messe === dateISO) : null;
                            const estLibre = !intention;

                            const li = document.createElement('li');
                            li.style.padding = "15px";
                            li.style.borderBottom = "1px solid #eee";
                            li.style.display = "flex";
                            li.style.justifyContent = "space-between";
                            li.style.alignItems = "center";

                            li.innerHTML = `
                                <div>
                                    <strong style="text-transform: capitalize;">${dateFr}</strong> à ${heureFr}<br>
                                    <span style="color: #666;">${event.summary}</span>
                                </div>
                                <div>
                                    ${estLibre 
                                        ? `<span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold;">LIBRE</span>` 
                                        : `<span style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold;">PRISE : ${intention.nom_intention}</span>`
                                    }
                                </div>
                            `;
                            listElement.appendChild(li);
                        }
                    });
                }
            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('chargement').innerHTML = "Erreur lors du chargement des données.";
            }
        }

        window.onload = fetchMessesEtIntentions;
    </script>
</body>
</html>
