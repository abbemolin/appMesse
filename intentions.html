<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Intentions - Paroisse</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .en_attente { background: #fff3cd; color: #856404; }
        .valide { background: #d4edda; color: #155724; }
        .refuse { background: #f8d7da; color: #721c24; }
        .action-group { display: flex; flex-direction: column; gap: 5px; }
        .btn-action { cursor: pointer; border: none; padding: 8px; border-radius: 4px; color: white; transition: 0.3s; }
        .btn-valider { background-color: #28a745; }
        .btn-refuser { background-color: #dc3545; }
        .btn-proposer { background-color: #ffc107; color: black; }
        input[type="text"], input[type="date"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="menu-container"></div>

    <main>
        <h1>Gestion des demandes d'intentions</h1>
        
        <div class="card">
            <h3>Liste des demandes √† traiter</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background: #f4f7f6; text-align: left;">
                        <th style="padding: 10px;">Date demand√©e</th>
                        <th>Intention pour</th>
                        <th>Demandeur</th>
                        <th>Statut</th>
                        <th style="width: 250px;">D√©cision du pr√™tre</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="menu.js"></script>
    <script>
        async function chargerDemandes() {
            const { data, error } = await maConnexion
                .from('intentions')
                .select('*')
                .order('date_messe', { ascending: true });

            if (error) return console.error(error);

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";

            data.forEach(item => {
                const dateFr = new Date(item.date_messe).toLocaleDateString('fr-FR');
                const tr = document.createElement('tr');
                tr.style.borderBottom = "1px solid #eee";
                
                tr.innerHTML = `
                    <td style="padding: 15px;">${dateFr}</td>
                    <td><strong>${item.nom_intention}</strong><br><small>${item.type_intention}</small></td>
                    <td>${item.nom_donateur}<br><small>${item.email_donateur}</small></td>
                    <td><span class="status-pill ${item.statut}">${item.statut.replace('_', ' ')}</span></td>
                    <td style="padding: 10px;">
                        ${item.statut === 'en_attente' ? `
                            <div class="action-group">
                                <button class="btn-action btn-valider" onclick="modifierStatut(${item.id}, 'valide')">‚úÖ Valider</button>
                                
                                <hr>
                                
                                <input type="text" id="motif-${item.id}" placeholder="Raison du refus...">
                                <button class="btn-action btn-refuser" onclick="modifierStatut(${item.id}, 'refuse')">‚ùå Refuser</button>
                                
                                <hr>
                                
                                <label><small>Proposer une autre date :</small></label>
                                <input type="date" id="newdate-${item.id}">
                                <button class="btn-action btn-proposer" onclick="proposerAutreDate(${item.id})">üìÖ Proposer date</button>
                            </div>
                        ` : `<small>Trait√© (Mail envoy√©: ${item.mail_envoye ? 'Oui' : 'Non'})</small>`}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function modifierStatut(id, nouveauStatut) {
            const motif = document.getElementById(`motif-${id}`)?.value || "";
            
            const { error } = await maConnexion
                .from('intentions')
                .update({ 
                    statut: nouveauStatut, 
                    reponse_pretre: motif,
                    mail_envoye: false // On r√©initialise pour que le script Google renvoie un mail
                })
                .eq('id', id);

            if (!error) chargerDemandes();
        }

        async function proposerAutreDate(id) {
            const nouvelleDate = document.getElementById(`newdate-${id}`).value;
            if (!nouvelleDate) return alert("Veuillez choisir une date √† proposer.");

            const dateFr = new Date(nouvelleDate).toLocaleDateString('fr-FR');
            const message = "La date initiale √©tait prise. Nous vous proposons le " + dateFr;

            const { error } = await maConnexion
                .from('intentions')
                .update({ 
                    statut: 'refuse', // On le marque comme refus√© pour la date initiale
                    reponse_pretre: message,
                    mail_envoye: false 
                })
                .eq('id', id);

            if (!error) {
                alert("Proposition envoy√©e au demandeur.");
                chargerDemandes();
            }
        }

        window.onload = chargerDemandes;
    </script>
</body>
</html>
