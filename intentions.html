<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traitement des Intentions</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/192/4f46e5/cross.png">
    <meta name="theme-color" content="#4f46e5">

    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; padding: 10px; }
        main { max-width: 1000px; margin: 0 auto; }
        h1 { color: #0f172a; font-weight: 800; text-align: center; font-size: 1.4rem; margin: 15px 0; }
        
        .table-container { background: transparent; border: none; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        thead { display: none; } 
        
        tr { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; padding: 15px; border: 1px solid #e2e8f0; }
        td { border: none; padding: 5px 0; display: block; }

        .date-badge { background: #4f46e5; color: white; border-radius: 8px; padding: 5px 10px; font-weight: 800; display: inline-block; }
        .heure-info { color: #4f46e5; font-weight: 700; margin-left: 10px; font-size: 0.9rem; }
        
        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .en_attente { background: #fef3c7; color: #92400e; }
        .valide { background: #dcfce7; color: #166534; }
        .refuse { background: #fee2e2; color: #991b1b; }

        .action-group { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; padding-top: 15px; border-top: 1px dashed #e2e8f0; }
        .btn-action { cursor: pointer; border: none; padding: 12px; border-radius: 8px; color: white; font-weight: 700; font-size: 0.9rem; width: 100%; }
        .btn-valider { background: #16a34a; }
        .btn-valider:disabled { background: #cbd5e1; color: #64748b; }
        .btn-refuser { background: #ef4444; }
        .btn-imposer { background: #0f172a; }
        .btn-supprimer { background: #b91c1c; margin-top: 5px; } /* Nouveau bouton rouge fonc√© */

        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .traite-info { font-size: 0.9rem; color: #64748b; font-style: italic; background: #f1f5f9; padding: 10px; border-radius: 8px; }

        @media (min-width: 768px) {
            thead { display: table-header-group; }
            tr { display: table-row; box-shadow: none; }
            td { display: table-cell; vertical-align: middle; padding: 15px; border-bottom: 1px solid #f1f5f9; }
            tr:last-child td { border-bottom: none; }
            .action-group { flex-direction: column; width: 220px; border-top: none; margin-top: 0; }
        }
    </style>
</head>
<body>
    <div id="menu-container"></div>
    <main>
        <h1>Gestion des Intentions</h1>
        <div id="loading-status" style="text-align:center; color:#64748b;">Chargement des demandes...</div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Messe</th>
                        <th>Intention</th>
                        <th>Demandeur</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="menu.js"></script>
    <script>
        const GOOGLE_API_KEY = 'AIzaSyAI5N6lamviexKaPR-WoOP4006m5IClDoQ';
        const CALENDAR_ID = 'saintlouisenville67@gmail.com';
        let intentionsGlobal = [];

        const normaliserDate = (d) => d ? d.split('T')[0] : '';

        async function chargerDemandes() {
            if (typeof maConnexion === 'undefined') { setTimeout(chargerDemandes, 500); return; }
            try {
                const url = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${GOOGLE_API_KEY}&singleEvents=true&orderBy=startTime&timeMin=${new Date().toISOString()}`;
                const resp = await fetch(url);
                const googleData = await resp.json();
                const events = googleData.items || [];

                const { data: intentions, error } = await maConnexion.from('intentions').select('*').order('date_messe', { ascending: true });
                if (error) throw error;
                
                intentionsGlobal = intentions;
                document.getElementById('loading-status').style.display = 'none';
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = "";

                const occupations = {};
                intentions.forEach(i => {
                    if (i.statut === 'valide') occupations[i.date_messe] = (occupations[i.date_messe] || 0) + 1;
                });

                intentions.forEach(item => {
                    const dateDb = item.date_messe;
                    const match = events.find(e => normaliserDate(e.start.dateTime || e.start.date) === dateDb && e.summary.toLowerCase().includes('messe'));

                    let heureAffiche = "√† confirmer";
                    let heureInput = "";
                    if (match && match.start.dateTime) {
                        const d = new Date(match.start.dateTime);
                        heureInput = d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        heureAffiche = "√† " + heureInput.replace(':', 'h');
                    }

                    const estOccupe = occupations[item.date_messe] >= 1 && item.statut !== 'valide';
                    const dateObj = new Date(item.date_messe);
                    const estEnCours = item.statut === 'en_attente' || item.en_edition === true;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="date-badge">${dateObj.getDate()} ${dateObj.toLocaleDateString('fr-FR', { month: 'short' })}</div>
                            <span class="heure-info">${heureAffiche}</span>
                        </td>
                        <td>
                            <div style="font-weight:800; font-size:1.1rem;">${item.nom_intention || 'Sans nom'}</div>
                            <div style="color:#64748b; font-size:0.8rem;">Type: ${item.type_intention}</div>
                        </td>
                        <td><div style="font-weight:600;">üë§ ${item.nom_donateur}</div></td>
                        <td><span class="status-pill ${item.statut}">${item.statut}</span></td>
                        <td>
                            ${estEnCours ? `
                                <div class="action-group">
                                    <button class="btn-action btn-valider" ${estOccupe ? 'disabled' : ''} onclick="valider('${item.id}', '${heureAffiche}')">
                                        ${estOccupe ? 'üîí Date d√©j√† occup√©e' : '‚úÖ Valider'}
                                    </button>
                                    <div style="font-size:0.7rem; font-weight:bold; color:#64748b; margin-top:5px;">MODIFIER OU D√âPLACER :</div>
                                    <input type="date" id="d-${item.id}" value="${item.date_messe}">
                                    <input type="text" id="h-${item.id}" placeholder="10:30" value="${heureInput}">
                                    <button class="btn-action btn-imposer" onclick="forcer('${item.id}')">üìÖ Confirmer changement</button>
                                    <button class="btn-action btn-refuser" onclick="refuser('${item.id}')">‚ùå Refuser</button>
                                    <button class="btn-action btn-supprimer" onclick="supprimer('${item.id}')">üóëÔ∏è Supprimer d√©finitivement</button>
                                </div>
                            ` : `
                                <div class="traite-info">
                                    ${item.reponse_pretre}
                                    <button style="width:100%; margin-top:10px; padding:8px; border-radius:6px; border:1px solid #cbd5e1;" onclick="editer('${item.id}')">‚úèÔ∏è Modifier</button>
                                </div>
                            `}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) { console.error(err); }
        }

        async function forcer(id) {
            const nDate = document.getElementById(`d-${id}`).value;
            const nHeure = document.getElementById(`h-${id}`).value;
            const dejaPris = intentionsGlobal.some(i => i.date_messe === nDate && i.statut === 'valide' && i.id != id);
            if (dejaPris) return alert("Date d√©j√† prise par une autre intention valid√©e.");
            
            const txt = `D√©plac√©e au ${new Date(nDate).toLocaleDateString('fr-FR')} √† ${nHeure.replace(':', 'h')}`;
            await maConnexion.from('intentions').update({ 
                date_messe: nDate, heure_messe: nHeure, statut: 'valide', 
                reponse_pretre: txt, mail_envoye: false, en_edition: false 
            }).eq('id', id);
            chargerDemandes();
        }

        async function valider(id, h) {
            const { data } = await maConnexion.from('intentions').select('date_messe').eq('id', id).single();
            const txt = `Valid√©e pour le ${new Date(data.date_messe).toLocaleDateString('fr-FR')} ${h}`;
            await maConnexion.from('intentions').update({ statut: 'valide', reponse_pretre: txt, mail_envoye: false, en_edition: false }).eq('id', id);
            chargerDemandes();
        }

        async function refuser(id) {
            if(!confirm("Refuser cette demande ?")) return;
            await maConnexion.from('intentions').update({ statut: 'refuse', reponse_pretre: 'Demande refus√©e.', mail_envoye: false, en_edition: false }).eq('id', id);
            chargerDemandes();
        }

        async function supprimer(id) {
            if(!confirm("‚ö†Ô∏è ATTENTION : Voulez-vous supprimer D√âFINITIVEMENT cette intention ? Cette action lib√©rera le calendrier et ne peut pas √™tre annul√©e.")) return;
            const { error } = await maConnexion.from('intentions').delete().eq('id', id);
            if (error) alert("Erreur lors de la suppression : " + error.message);
            else chargerDemandes();
        }

        async function editer(id) {
            await maConnexion.from('intentions').update({ en_edition: true }).eq('id', id);
            chargerDemandes();
        }

        window.onload = chargerDemandes;
    </script>
</body>
</html>
