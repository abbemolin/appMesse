<script>
    console.log("Supabase Client Initialis√© :", typeof maConnexion !== 'undefined');

    async function chargerDemandes() {
        try {
            const { data, error } = await maConnexion
                .from('intentions')
                .select('*')
                .order('date_messe', { ascending: true });

            if (error) throw error;
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";

            data.forEach(item => {
                const dateObj = new Date(item.date_messe);
                const tr = document.createElement('tr');
                const estEnCours = item.statut === 'en_attente' || item.en_edition === true;
                const idPropre = String(item.id);
                
                // Nettoyage de l'affichage de l'heure
                const heureAffichee = item.heure_messe ? item.heure_messe.substring(0, 5).replace(':', 'h') : '--:--';

                tr.innerHTML = `
                    <td class="date-col">
                        <div class="date-badge">
                            <span>${dateObj.toLocaleDateString('fr-FR', { month: 'short' })}</span>
                            ${dateObj.getDate()}
                            <div class="annee">${dateObj.getFullYear()}</div>
                        </div>
                        <span class="heure-info">√† ${heureAffichee}</span>
                    </td>
                    <td>
                        <div style="font-weight:700; color:#0f172a">${item.nom_intention || 'Sans nom'}</div>
                        <div style="font-size:0.8rem; color:#64748b">${item.type_intention}</div>
                        ${item.commentaire ? `<div style="font-size:0.75rem; font-style:italic; margin-top:6px; color:#94a3b8">"${item.commentaire}"</div>` : ''}
                    </td>
                    <td>
                        <div style="font-size:0.9rem; font-weight:500">${item.nom_donateur}</div>
                        <div style="font-size:0.75rem; color:#94a3b8">${item.email_donateur || ''}</div>
                    </td>
                    <td>
                        <span class="status-pill ${item.statut}">${item.statut.replace('_', ' ')}</span>
                    </td>
                    <td>
                        ${estEnCours ? `
                            <div class="action-group">
                                <button class="btn-action btn-valider" onclick="modifierStatut('${idPropre}', 'valide')">‚úÖ Valider</button>
                                <div>
                                    <input type="text" id="motif-${idPropre}" placeholder="Note / Motif de refus">
                                    <button class="btn-action btn-refuser" style="width:100%; margin-top:6px;" onclick="modifierStatut('${idPropre}', 'refuse')">‚ùå Refuser</button>
                                </div>
                                <hr style="width:100%; border:0; border-top:1px solid #e2e8f0; margin: 5px 0;">
                                <div>
                                    <span style="font-size:0.7rem; font-weight:bold; color:#64748b; text-transform:uppercase;">Changer Date/Heure :</span>
                                    <input type="date" id="newdate-${idPropre}" style="margin-top:4px" value="${item.date_messe}">
                                    <input type="text" id="newhour-${idPropre}" placeholder="ex: 18:30" style="margin-top:4px" value="${heureAffichee}">
                                    <button class="btn-action btn-imposer" style="width:100%; margin-top:6px;" onclick="imposerNouveauCreneau('${idPropre}')">üìÖ Valider ce cr√©neau</button>
                                </div>
                            </div>
                        ` : `
                            <div class="traite-info">
                                <strong>R√©ponse envoy√©e :</strong><br>${item.reponse_pretre || 'Accept√©e'}<br>
                                <div style="margin-top:8px; font-size:0.75rem;">
                                    Status Email : ${item.mail_envoye ? '‚úÖ Envoy√©' : '‚è≥ En attente'}
                                </div>
                                <button class="btn-action btn-edit" onclick="activerEdition('${idPropre}')">‚úèÔ∏è Modifier / D√©placer</button>
                            </div>
                        `}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("Erreur:", err);
        }
    }

    async function modifierStatut(id, nouveauStatut) {
        // R√©cup√©ration des infos actuelles pour le message
        const { data: item } = await maConnexion.from('intentions').select('date_messe, heure_messe').eq('id', id).single();
        const dateFr = new Date(item.date_messe).toLocaleDateString('fr-FR');
        const heureFr = item.heure_messe ? item.heure_messe.substring(0, 5).replace(':', 'h') : '';

        const motifInput = document.getElementById(`motif-${id}`);
        const messageAuto = nouveauStatut === 'valide' 
            ? `Votre intention a √©t√© valid√©e pour la messe du ${dateFr} √† ${heureFr}.`
            : `D√©sol√©, nous ne pouvons pas honorer votre demande pour le ${dateFr}.`;

        const motif = motifInput?.value || messageAuto;

        const { error } = await maConnexion
            .from('intentions')
            .update({ 
                statut: nouveauStatut, 
                reponse_pretre: motif, 
                mail_envoye: false,
                en_edition: false 
            })
            .eq('id', id);

        if (error) alert(error.message);
        else chargerDemandes();
    }

    async function imposerNouveauCreneau(id) {
        const nDate = document.getElementById(`newdate-${id}`).value;
        const nHeure = document.getElementById(`newhour-${id}`).value.replace('h', ':');
        
        if (!nDate) return alert("Date manquante");

        const { error } = await maConnexion
            .from('intentions')
            .update({ 
                date_messe: nDate, 
                heure_messe: nHeure,
                statut: 'valide', 
                reponse_pretre: `Intention fix√©e au ${new Date(nDate).toLocaleDateString('fr-FR')} √† ${nHeure}`, 
                mail_envoye: false,
                en_edition: false
            })
            .eq('id', id);

        if (error) alert(error.message);
        else chargerDemandes();
    }

    async function activerEdition(id) {
        await maConnexion.from('intentions').update({ en_edition: true }).eq('id', id);
        chargerDemandes();
    }

    window.onload = chargerDemandes;
</script>
