<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Intentions</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="menu-container"></div>

    <main>
        <h1>Gestion des Intentions</h1>

        <section class="card">
            <h3>Ajouter manuellement</h3>
            <form id="form-intention" style="display: grid; gap: 10px;">
                <input type="text" id="nom_donateur" placeholder="Nom du demandeur" required>
                <input type="text" id="nom_intention" placeholder="Prénom/Nom pour la messe" required>
                <input type="date" id="date_messe" required>
                <select id="type_intention">
                    <option value="Défunt">Défunt</option>
                    <option value="Vivant">Vivant / Action de grâce</option>
                    <option value="Particulière">Particulière</option>
                </select>
                <button type="submit" style="background-color: #2c3e50; color: white; padding: 10px;">Enregistrer</button>
            </form>
        </section>

        <br><hr><br>

        <section>
            <h3>Demandes à traiter</h3>
            <table border="1" style="width: 100%; border-collapse: collapse; background: white;">
                <thead style="background: #f4f7f6;">
                    <tr>
                        <th>Date Messe</th>
                        <th>Intention pour</th>
                        <th>Type</th>
                        <th>Demandeur</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="liste-intentions">
                    </tbody>
            </table>
        </section>
    </main>

    <script src="config.js"></script>
    <script src="menu.js"></script>

    <script>
        // 1. Charger les intentions au démarrage
        async function chargerIntentions() {
            const { data, error } = await maConnexion
                .from('intentions')
                .select('*')
                .order('date_messe', { ascending: true });

            if (error) {
                console.error("Erreur de chargement:", error);
                return;
            }

            const corpsTableau = document.getElementById('liste-intentions');
            corpsTableau.innerHTML = ""; // On vide pour rafraîchir

            data.forEach(item => {
                const ligne = `
                    <tr>
                        <td>${item.date_messe}</td>
                        <td><b>${item.nom_intention}</b></td>
                        <td>${item.type_intention}</td>
                        <td>${item.nom_donateur}</td>
                        <td>
                            <button onclick="changerStatut(${item.id}, 'valide')" style="color: green;">Valider</button>
                            <button onclick="changerStatut(${item.id}, 'refuse')" style="color: red;">Refuser</button>
                        </td>
                    </tr>
                `;
                corpsTableau.innerHTML += ligne;
            });
        }

        // 2. Fonction pour changer le statut (Valider/Refuser)
        async function changerStatut(id, nouveauStatut) {
            const { error } = await maConnexion
                .from('intentions')
                .update({ statut: nouveauStatut })
                .eq('id', id);

            if (error) {
                alert("Erreur lors de la mise à jour");
            } else {
                alert("Statut mis à jour : " + nouveauStatut);
                chargerIntentions(); // On recharge la liste
            }
        }

        // 3. Gestion du formulaire d'ajout
        document.getElementById('form-intention').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nouvelleIntention = {
                nom_donateur: document.getElementById('nom_donateur').value,
                nom_intention: document.getElementById('nom_intention').value,
                date_messe: document.getElementById('date_messe').value,
                type_intention: document.getElementById('type_intention').value,
                email_donateur: "test@test.fr", // Email temporaire pour le test
                statut: 'en_attente'
            };

            const { error } = await maConnexion.from('intentions').insert([nouvelleIntention]);
            if (!error) {
                document.getElementById('form-intention').reset();
                chargerIntentions();
            }
        });

        window.onload = chargerIntentions;
    </script>
</body>
</html>
